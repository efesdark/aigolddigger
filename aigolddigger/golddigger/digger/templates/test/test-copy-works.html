<!-- candles.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Candlestick Chart</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="{% static 'js/lightweight-charts.standalone.production.js' %}"></script>
</head>
<body>
    <div id="bitcoinChart" style="width: 800px; height: 400px;"></div>
    <button class="button-live" data-value="Time">Time(live)</button>
    <button class="button-t" data-value="1m">1m</button>
    <button class="button-t" data-value="3m">3m</button>
    <button class="button-t" data-value="5m">5m</button>
    <button class="button-t" data-value="15m">15m</button>
    <button class="button-t" data-value="30m">30m</button>
    <button class="button-t" data-value="1h">1h</button>
    <button class="button-t" data-value="2h">2h</button>
    <button class="button-t" data-value="4h">4h</button>
    <button class="button-t" data-value="6h">6h</button>
    <button class="button-t" data-value="8h">8h</button>
    <button class="button-t" data-value="12h">12h</button>
    <button class="button-t" data-value="1d">1d</button>
    <button class="button-t" data-value="1d">3d</button>
    <button class="button-t" data-value="1w">1w</button>
    <button class="button-t" data-value="1w">1m</button>
    <button class="button-v" data-value="v">v</button>
    <div id="message"></div>

    <script>
        const chart = LightweightCharts.createChart(document.getElementById('bitcoinChart'), {
            width: 800,
            height: 400,
        });
        let candlestickSeries;

        document.addEventListener('DOMContentLoaded', function () {
            const formattedData = {{ formatted_data|safe }};
            chart.timeScale().fitContent();

            const timesframe = formattedData.map(item => item.timesframe);
            const firstTime = timesframe[0];
            let timeScaleOptions;

            if (firstTime.includes('1d')) {
                timeScaleOptions = {
                    timeVisible: true,
                    secondsVisible: false,
                };
            } else {
                timeScaleOptions = {
                    timeVisible: true,
                    secondsVisible: true,
                };
            }

            chart.applyOptions({
                timeScale: timeScaleOptions,
            });

            candlestickSeries = chart.addCandlestickSeries();
            candlestickSeries.setData(formattedData);
        });

        const csrftoken = '{{ csrf_token }}';

        $(document).ready(function () {
            $(".button-t").click(function () {
                var selection = $(this).data("value");
                var buttons = document.getElementsByClassName("button-t");

                for (var i = 0; i < buttons.length; i++) {
                    buttons[i].disabled = true;
                }

                // Seriyi temizleme işlemi
                chart.removeSeries(candlestickSeries);
                candlestickSeries = chart.addCandlestickSeries();

                $.ajax({
                    url: "{% url 'test_message' %}",
                    type: "POST",
                    data: {
                        binance_timeframe: selection,
                    },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    },
                    success: function (response) {
                        for (var i = 0; i < buttons.length; i++) {
                            buttons[i].disabled = false;
                        }

                        var formatted_data = response.formatted_data;
                        console.log("Formatted data:", formatted_data);

                        // Eski verileri temizle
                        $("#message").html('');

                        // Yeni verileri ekle
                        formatted_data.forEach(function (entry) {
                            $("#message").append(JSON.stringify(entry) + '<br>');
                        });

                        // Grafiği güncelle
                        updateChart(formatted_data);
                    },
                });
            });

            function updateChart(data) {
                candlestickSeries.setData(data);
            }
        });
    </script>

    <div id="resultContainer"></div>
    <div id="message"></div>
    <div id="formattedDataContainer"></div>
</body>
</html>
